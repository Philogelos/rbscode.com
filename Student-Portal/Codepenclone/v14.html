<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RBS Code Studio</title>

  <style>
    :root{
      --bg0:#070716;
      --bg1:#0b1026;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.085);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.64);
      --a1:#7c3aed;
      --a2:#22d3ee;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,0.55);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:
        radial-gradient(1100px 700px at 15% 15%, rgba(124,58,237,0.35), transparent 55%),
        radial-gradient(900px 650px at 85% 20%, rgba(34,211,238,0.18), transparent 55%),
        radial-gradient(900px 650px at 60% 95%, rgba(124,58,237,0.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:14px;
      gap:12px;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 12px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.08);
      min-width: 190px;
    }

    .logo{
      width:26px; height:26px; border-radius:10px;
      background:
        radial-gradient(10px 10px at 30% 30%, rgba(34,211,238,0.95), rgba(34,211,238,0) 60%),
        radial-gradient(16px 16px at 70% 70%, rgba(124,58,237,0.95), rgba(124,58,237,0) 60%),
        linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.18);
      box-shadow: 0 0 0 1px rgba(124,58,237,0.15), 0 0 30px rgba(124,58,237,0.10);
    }
    .brand h1{
      margin:0;
      font-size:13px;
      letter-spacing:0.6px;
      font-weight:800;
      line-height:1.1;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .dot{
      width:8px;height:8px;border-radius:50%;
      background: transparent;
      border:1px solid rgba(255,255,255,0.25);
      display:inline-block;
    }
    .dot.dirty{
      background: rgba(255,255,255,0.85);
      border-color: rgba(255,255,255,0.85);
    }

    .spacer{ flex:1; }

    .field{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      min-width: 220px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .field input{
      width:100%;
      background: transparent;
      border:none;
      outline:none;
      color: var(--text);
      font-size:13px;
    }

    .btns{ display:flex; align-items:center; gap:8px; }
    button{
      border:none;
      color:var(--text);
      background: rgba(255,255,255,0.07);
      border:1px solid rgba(255,255,255,0.10);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      letter-spacing:0.3px;
      transition: transform 0.08s ease, background 0.2s ease, border-color 0.2s ease;
      user-select:none;
      white-space:nowrap;
    }
    button:hover{
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.16);
    }
    button:active{ transform: translateY(1px); }

    .primary{
      background: linear-gradient(135deg, rgba(124,58,237,0.95), rgba(34,211,238,0.65));
      border:1px solid rgba(255,255,255,0.18);
      box-shadow: 0 0 0 1px rgba(124,58,237,0.10), 0 10px 30px rgba(124,58,237,0.20);
    }
    .primary:hover{ filter: brightness(1.06); }

    .chip{
      font-size:12px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      color: var(--muted);
      min-width: 170px;
      text-align:center;
    }
    .chip.ok{ color: rgba(34,197,94,0.92); border-color: rgba(34,197,94,0.25); }
    .chip.warn{ color: rgba(245,158,11,0.92); border-color: rgba(245,158,11,0.25); }
    .chip.bad{ color: rgba(239,68,68,0.92); border-color: rgba(239,68,68,0.25); }

    .main{
      flex:1;
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:12px;
      min-height:0;
    }

    .card{
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      background:
        radial-gradient(400px 120px at 20% 0%, rgba(124,58,237,0.25), transparent 60%),
        radial-gradient(380px 120px at 80% 0%, rgba(34,211,238,0.18), transparent 60%),
        rgba(0,0,0,0.18);
    }

    .tabs{ display:flex; gap:8px; align-items:center; }
    .tab{
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      color: var(--muted);
      transition: all 0.2s ease;
      user-select:none;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(124,58,237,0.35);
      box-shadow: 0 0 0 1px rgba(124,58,237,0.10), 0 0 22px rgba(124,58,237,0.18);
      background: rgba(124,58,237,0.12);
    }

    .hint{
      font-size:12px;
      color: var(--muted);
      padding-right:6px;
      white-space:nowrap;
    }

    .editorArea{
      height: calc(100% - 48px);
      min-height:0;
    }
    #editor{ height:100%; width:100%; }

    .previewArea{
      height: calc(100% - 48px);
      min-height:0;
      background: rgba(0,0,0,0.15);
      position:relative;
    }
    iframe{
      width:100%;
      height:100%;
      border:none;
      background:white;
    }

    .fullOverlay{
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: #000;
      display:none;
    }
    .fullOverlay.active{ display:block; }
    .fullOverlay iframe{
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }
    .fullExit{
      position:absolute;
      top:12px;
      right:12px;
      z-index: 10000;
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.55);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .main{ grid-template-columns: 1fr; }
      .wrap{ height:auto; }
      .editorArea, .previewArea{ height: 520px; }
      .field{ min-width: 160px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>RBS Code Studio</h1>
          <div class="sub">
            <span class="dot" id="dirtyDot" title="Unsaved changes"></span>
            <span id="dirtyText">Saved</span>
          </div>
        </div>
      </div>

      <div class="field" title="Project name (used for autosave key)">
        <label>Project</label>
        <input id="projectName" value="clicker-game-1" />
      </div>

      <div class="chip" id="statusChip">Ready</div>

      <div class="spacer"></div>

      <div class="btns">
        <button id="btnRun" class="primary" title="Ctrl+Enter">Run</button>
        <button id="btnSave" title="Ctrl+S">Save</button>
        <button id="btnDownloadHtml" title="Download a single HTML file">Download HTML</button>
        <button id="btnDownloadZip" title="Download a folder zip (index.html, style.css, script.js)">Download ZIP</button>
        <button id="btnFull" title="Full preview (Esc to exit)">Full Preview</button>
        <button id="btnReset" title="Reset project to starter template">Reset</button>
      </div>
    </div>

    <div class="main">
      <div class="card">
        <div class="cardHead">
          <div class="tabs">
            <div class="tab active" data-lang="html">HTML</div>
            <div class="tab" data-lang="css">CSS</div>
            <div class="tab" data-lang="javascript">JS</div>
          </div>
          <div class="hint">Shortcuts: Ctrl+S save, Ctrl+Enter run, Ctrl+Space suggestions</div>
        </div>
        <div class="editorArea">
          <div id="editor"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="tabs">
            <div class="tab active" style="cursor:default;">Preview</div>
          </div>
          <div class="hint">Runs only when you click Run</div>
        </div>
        <div class="previewArea">
          <iframe id="preview" sandbox="allow-scripts"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="fullOverlay" id="fullOverlay">
    <div class="fullExit" id="fullExit">Exit Full Preview (Esc)</div>
    <iframe id="fullPreview" sandbox="allow-scripts"></iframe>
  </div>

  <!-- JSZip for ZIP downloads -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Monaco loader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/loader.min.js"></script>

  <script>
    // --- Defaults ---
    const DEFAULT = {
      html: `<h1 id="title">Hello RBS Code</h1>
<button id="btn">Click me</button>
<p>Clicks: <span id="count">0</span></p>`,
      css: `body{
  font-family: Arial, sans-serif;
  text-align:center;
  padding:30px;
}
#btn{
  padding:12px 18px;
  border-radius:12px;
  border:none;
  cursor:pointer;
}
#title{ margin-bottom:16px; }`,
      javascript: `let count = 0;

const btn = document.getElementById("btn");
const countSpan = document.getElementById("count");

btn.addEventListener("click", function(){
  count++;
  countSpan.innerText = count;
});`
    };

    // --- UI refs ---
    const preview = document.getElementById("preview");
    const projectNameInput = document.getElementById("projectName");
    const statusChip = document.getElementById("statusChip");

    const dirtyDot = document.getElementById("dirtyDot");
    const dirtyText = document.getElementById("dirtyText");

    const btnRun = document.getElementById("btnRun");
    const btnSave = document.getElementById("btnSave");
    const btnDownloadHtml = document.getElementById("btnDownloadHtml");
    const btnDownloadZip = document.getElementById("btnDownloadZip");
    const btnReset = document.getElementById("btnReset");

    const btnFull = document.getElementById("btnFull");
    const fullOverlay = document.getElementById("fullOverlay");
    const fullPreview = document.getElementById("fullPreview");
    const fullExit = document.getElementById("fullExit");

    // --- State ---
    let monacoEditor = null;
    let models = {};
    let activeLang = "html";
    let isDirty = false;
    let lastRanSrcdoc = "";

    function keyPrefix(){
      const name = (projectNameInput.value || "project").trim();
      return "rbsstudio:" + name + ":";
    }

    function setStatus(text, kind){
      statusChip.textContent = text;
      statusChip.classList.remove("ok","warn","bad");
      if(kind) statusChip.classList.add(kind);
    }

    function setDirty(dirty){
      isDirty = dirty;
      dirtyDot.classList.toggle("dirty", dirty);
      dirtyText.textContent = dirty ? "Unsaved" : "Saved";
    }

    function safeGet(k){ try{ return localStorage.getItem(k); }catch(e){ return null; } }
    function safeSet(k,v){ try{ localStorage.setItem(k,v); }catch(e){} }

    function loadProject(){
      const p = keyPrefix();
      const html = safeGet(p+"html") ?? DEFAULT.html;
      const css = safeGet(p+"css") ?? DEFAULT.css;
      const js  = safeGet(p+"js")  ?? DEFAULT.javascript;

      models.html.setValue(html);
      models.css.setValue(css);
      models.javascript.setValue(js);

      setDirty(false);
      setStatus("Loaded", "ok");
      // Do NOT auto-run (per your request)
    }

    function saveProject(){
      const p = keyPrefix();
      safeSet(p+"html", models.html.getValue());
      safeSet(p+"css", models.css.getValue());
      safeSet(p+"js",  models.javascript.getValue());
      setDirty(false);
      setStatus("Saved", "ok");
    }

    function resetProject(){
      models.html.setValue(DEFAULT.html);
      models.css.setValue(DEFAULT.css);
      models.javascript.setValue(DEFAULT.javascript);
      setDirty(true);
      setStatus("Reset", "warn");
    }

    function buildSrcDoc(){
      const html = models.html.getValue();
      const css = models.css.getValue();
      const js = models.javascript.getValue();

      // Keep it simple + professional: JS errors render in-page, but do NOT leak try{} into HTML.
      // Note: we must escape </script> inside a template literal.
      return `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Project</title>
<style>
${css}
</style>
</head>
<body>
${html}
<script>
(function(){
  try{
${js}
  }catch(e){
    var pre = document.createElement("pre");
    pre.style.whiteSpace = "pre-wrap";
    pre.style.color = "crimson";
    pre.style.fontFamily = "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
    pre.textContent = "JS Error: " + (e && e.message ? e.message : String(e));
    document.body.appendChild(pre);
    console.error(e);
  }
})();
<\/script>
</body>
</html>`;
    }

    function runCode(){
      lastRanSrcdoc = buildSrcDoc();
      preview.srcdoc = lastRanSrcdoc;
      fullPreview.srcdoc = lastRanSrcdoc;
      setStatus("Ran", "ok");
    }

    function downloadHTML(){
      const blob = new Blob([lastRanSrcdoc || buildSrcDoc()], {type:"text/html"});
      const a = document.createElement("a");
      const name = (projectNameInput.value || "rbs-project").trim().replace(/[^a-z0-9\-_]+/gi,"-");
      a.href = URL.createObjectURL(blob);
      a.download = name + ".html";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function downloadZIP(){
      const zip = new JSZip();
      const name = (projectNameInput.value || "rbs-project").trim().replace(/[^a-z0-9\-_]+/gi,"-");
      const folder = zip.folder(name);

      const html = models.html.getValue();
      const css = models.css.getValue();
      const js = models.javascript.getValue();

      const indexHtml = `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${name}</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
${html}
<script src="script.js"></script>
</body>
</html>`;

      folder.file("index.html", indexHtml);
      folder.file("style.css", css);
      folder.file("script.js", js);

      const blob = await zip.generateAsync({type:"blob"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name + ".zip";
      a.click();
      URL.revokeObjectURL(a.href);

      setStatus("ZIP downloaded", "ok");
    }

    function openFullPreview(){
      fullOverlay.classList.add("active");
      // keep it on the last run, do not auto-run here
      fullPreview.srcdoc = lastRanSrcdoc || buildSrcDoc();
    }
    function closeFullPreview(){
      fullOverlay.classList.remove("active");
    }

    function debounce(ms, fn){
      let t = null;
      return function(){
        clearTimeout(t);
        t = setTimeout(fn, ms);
      };
    }

    function setActiveTab(lang){
      activeLang = lang;
      document.querySelectorAll(".tab[data-lang]").forEach(t=>{
        t.classList.toggle("active", t.dataset.lang === lang);
      });
      monacoEditor.setModel(models[lang]);
      monacoEditor.focus();
      setStatus("Editing: " + (lang==="javascript" ? "JS" : lang.toUpperCase()));
    }

    // ===== Monaco init =====
    require.config({
      paths:{ vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs" }
    });

    require(["vs/editor/editor.main"], function(){
      // Create models
      models.html = monaco.editor.createModel(DEFAULT.html, "html");
      models.css = monaco.editor.createModel(DEFAULT.css, "css");
      models.javascript = monaco.editor.createModel(DEFAULT.javascript, "javascript");

      // Editor
      monacoEditor = monaco.editor.create(document.getElementById("editor"), {
        model: models.html,
        theme: "vs-dark",
        fontSize: 14,
        minimap: { enabled: false },
        automaticLayout: true,
        scrollBeyondLastLine: false,
        roundedSelection: true,
        smoothScrolling: true,
        tabSize: 2,
        wordWrap: "on"
      });

      // ----- Emmet-like tag expansion: type "p" -> Enter -> <p></p> -----
      // This is intentionally minimal and stable (no weird blank suggestions).
      const TAGS = new Set([
        "div","p","span","h1","h2","h3","h4","h5","h6","button","a","img","ul","ol","li",
        "input","label","section","header","footer","main","nav","article","aside",
        "strong","em","b","i","u","small","br","hr","pre","code"
      ]);

      monaco.languages.registerCompletionItemProvider("html", {
        triggerCharacters: [" ", "\n", "\t"].concat(
          "abcdefghijklmnopqrstuvwxyz".split("")
        ),
        provideCompletionItems: function(model, position){
          // Only for HTML model
          if (model !== models.html) return { suggestions: [] };

          const wordInfo = model.getWordUntilPosition(position);
          const word = (wordInfo && wordInfo.word) ? wordInfo.word : "";
          if(!word) return { suggestions: [] };

          // Avoid offering this inside an already-started tag like "<p"
          const line = model.getLineContent(position.lineNumber);
          const before = line.slice(0, Math.max(0, position.column - 1));
          if (before.endsWith("<" + word)) return { suggestions: [] };

          // Only offer for known tags and only if it's a "plain word" (letters only)
          if(!/^[a-zA-Z]+$/.test(word)) return { suggestions: [] };
          const lower = word.toLowerCase();
          if(!TAGS.has(lower)) return { suggestions: [] };

          const range = new monaco.Range(
            position.lineNumber,
            wordInfo.startColumn,
            position.lineNumber,
            wordInfo.endColumn
          );

          const isVoid = (lower === "img" || lower === "br" || lower === "hr" || lower === "input");

          const insertText = isVoid
            ? `<${lower} $0>`
            : `<${lower}>$0</${lower}>`;

          return {
            suggestions: [{
              label: lower,                 // <- NOT BLANK
              detail: isVoid ? "Emmet: <tag>" : "Emmet: <tag></tag>",
              documentation: "Press Enter to expand",
              kind: monaco.languages.CompletionItemKind.Snippet,
              insertText: insertText,
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              range: range,
              sortText: "0000" + lower
            }]
          };
        }
      });

      // Wire tabs
      document.querySelectorAll(".tab[data-lang]").forEach(t=>{
        t.addEventListener("click", ()=> setActiveTab(t.dataset.lang));
      });

      // Buttons
      btnRun.addEventListener("click", runCode);
      btnSave.addEventListener("click", saveProject);
      btnDownloadHtml.addEventListener("click", downloadHTML);
      btnDownloadZip.addEventListener("click", downloadZIP);
      btnReset.addEventListener("click", resetProject);
      btnFull.addEventListener("click", openFullPreview);
      fullExit.addEventListener("click", closeFullPreview);

      // Keyboard shortcuts
      window.addEventListener("keydown", (e)=>{
        const isMac = navigator.platform.toUpperCase().includes("MAC");
        const ctrl = isMac ? e.metaKey : e.ctrlKey;

        if(e.key === "Escape"){
          closeFullPreview();
        }

        if(ctrl && (e.key === "s" || e.key === "S")){
          e.preventDefault();
          saveProject();
        }
        if(ctrl && e.key === "Enter"){
          e.preventDefault();
          runCode();
        }
      });

      // Dirty tracking (no auto-run)
      const markDirtySoon = debounce(80, ()=>{
        if(!isDirty){
          setDirty(true);
          setStatus("Unsaved changes", "warn");
        }else{
          setStatus("Typingâ€¦", "warn");
        }
      });

      monacoEditor.onDidChangeModelContent(() => {
        markDirtySoon();
      });

      // Project name change loads new key
      projectNameInput.addEventListener("change", loadProject);

      // Initial load
      loadProject();

      // Initial preview is blank until Run (your preference)
      preview.srcdoc = "<!doctype html><html><body style='font-family:Arial;padding:20px;'>Click <b>Run</b> to preview.</body></html>";
      fullPreview.srcdoc = preview.srcdoc;

      setStatus("Ready", "ok");
      setDirty(false);
    });
  </script>
</body>
</html>
